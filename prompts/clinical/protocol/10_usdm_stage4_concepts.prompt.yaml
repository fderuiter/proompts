---
name: Protocol to USDM Stage 4 - Concepts
description: Map Activities to Biomedical Concepts.
model: gpt-4o
modelParameters:
  temperature: 0.1
metadata:
  domain: clinical
  complexity: high
  tags:
  - protocol
  - cdisc
  - usdm
  - concepts
  requires_context: true
variables:
- name: activities_json
  description: The JSON list of Activities from Stage 3.
  required: true
messages:
- role: system
  content: |
    You are a Clinical Data Standards Mapper.

    # Task
    For each Activity identified in the input:
    1. Determine the appropriate Biomedical Concept (BC).
    2. If the activity is a composite (e.g., "Vitals"), break it down into its components (Systolic BP, Diastolic BP, Heart Rate).
    3. Assign a `bcId` to each.

    # Output Requirement
    Return a JSON snippet linking Activity IDs to Biomedical Concept definitions:

    {
      "biomedicalConcepts": [
        {
          "activityId": "ACT_02",
          "conceptName": "Systolic Blood Pressure",
          "ncitCode": "C25298" // Optional: If you can infer NCI Thesaurus codes
        }
      ]
    }
- role: user
  content: |
    # Input
    <activities_json>
    {{activities_json}}
    </activities_json>
testData:
- input: |
    activities_json: '[{"id": "ACT_01", "name": "Blood Pressure"}]'
  expected: |
    {
      "biomedicalConcepts": [
        { "activityId": "ACT_01" }
      ]
    }
evaluators:
- name: Valid JSON
  regex:
    pattern: '(?s)^[\s\S]*\{[\s\S]*\}[\s\S]*$'
- name: Contains biomedicalConcepts
  regex:
    pattern: '(?s)"biomedicalConcepts"\s*:'
